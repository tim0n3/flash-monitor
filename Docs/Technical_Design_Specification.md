# Technical Design Specification
## Script Name: disk_space_monitor.sh

### Purpose:
The purpose of the script is to monitor the available storage space on physical storage devices and log this information to a CSV file. Additionally, it checks for significant changes in free space and updates a lock file accordingly. If the free space changes by more than 5%, it sets the lock file to '1'; otherwise, it sets it to '0'. The script also periodically truncates log files in the `/var/log/` directory.

### Prerequisites:
1. The script is designed to run on a Linux system.
2. The script assumes that `bc`, `truncate`, `lsblk`, `df`, and `awk` utilities are installed and available in the system.

### Script Components:

#### 1. Variables:
   - `output_file`: The path to the CSV file where storage information will be logged. The filename includes a timestamp.
   - `lock_file`: The path to the lock file that indicates whether there has been a significant change in free space.
   - `prev_avail_space`: Variable to store the previous available space for comparison.

#### 2. `truncate_logs()` Function:
   - Purpose: Truncates all log files in the `/var/log/` directory.
   - Implementation: Uses the `find` command to identify log files and `truncate` to empty them.

#### 3. `monitor_storage()` Function:
   - Purpose: Continuously monitors storage space, calculates the percentage change, and updates the lock file accordingly.
   - Implementation:
     - Finds the latest CSV log file.
     - Extracts the latest available space from the CSV log.
     - Compares the change in available space with the previous value.
     - If the change is greater than 5%, it sets the lock file to '1'; otherwise, it sets it to '0'.
     - Sleeps for 30 seconds between checks.

#### 4. Main Script:
   - Writes the CSV file header.
   - Lists physical storage devices using `lsblk`.
   - For each device, it retrieves the available space and appends this information to the CSV file.
   - Initiates the `monitor_storage` function in the background.
   - Continuously checks the lock file and takes appropriate actions based on its value.
     - If the lock value is '1', it truncates log files.
     - If the lock value is '0', it takes no action.
     - Sleeps for 60 seconds between checks.

### Usage:
1. Ensure that the script has execute permission.
   ```
   chmod +x disk_space_monitor.sh
   ```

2. Run the script.
   ```
   ./disk_space_monitor.sh
   ```

### Scalability and Future Improvements:
- The script can be extended to include more detailed storage information, such as individual partitions.
- Error handling can be enhanced to handle cases where required utilities are not available.
- Logging and notification mechanisms can be added for better monitoring and reporting.
- The script can be scheduled as a cron job for automatic execution at specific intervals.

### Dependencies:
- `bc`: Used for arithmetic calculations.
- `truncate`: Used to empty log files.
- `lsblk`: Used to list physical storage devices.
- `df`: Used to retrieve available space.
- `awk`: Used for text processing.

### Compatibility:
The script is compatible with Linux systems and may require adjustments for other operating systems. Ensure that the required utilities are available and paths are correctly configured for the specific system.

### Security Considerations:
- The script should be run with appropriate permissions, as it deals with system files and may write to system directories.
- Care should be taken when scheduling the script to run as a background process to avoid excessive resource consumption.

### Maintenance:
- Regularly review and update the script to ensure it remains compatible with the system and any changes in requirements.
- Monitor the log files generated by the script for any errors or anomalies.